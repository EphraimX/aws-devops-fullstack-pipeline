# ---------- Builder + Runtime ----------
FROM node:21.5-bullseye-slim

WORKDIR /usr/src/app

# Copy package files and install dependencies
COPY package*.json ./
RUN npm install --force

# Install pm2 globally
RUN npm install -g pm2

# Copy rest of the application
COPY . .

# Accept environment variable for public API URL
ARG NEXT_PUBLIC_APIURL
ENV NEXT_PUBLIC_APIURL=$NEXT_PUBLIC_APIURL

# Build the Next.js app (server-side)
RUN npm run build

# Expose Next.js default port
EXPOSE 3000

# Use PM2 to run Next.js
CMD ["pm2-runtime", "start", "npm", "--", "start"]